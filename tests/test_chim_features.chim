// Chim编译器测试文件
// 测试类型系统、生命周期、逃逸分析和循环优化

// 测试1: 基本类型和泛型类型
fn test_basic_types() {
    let x: int = 42;
    let y: float = 3.14;
    let flag: bool = true;
    let msg: string = "Hello, Chim!";

    println(x);
    println(y);
    println(flag);
    println(msg);
}

// 测试2: 泛型容器类型
fn test_generic_types() {
    let numbers: List[int] = [1, 2, 3, 4, 5];
    let names: List[string] = ["Alice", "Bob", "Charlie"];

    // Result类型
    let success: Result[int, string] = Ok(100);
    let failure: Result[int, string] = Err("Something went wrong");

    // Optional类型
    let present: Optional[int] = Some(42);
    let absent: Optional[int] = None;

    println(numbers);
    println(names);
}

// 测试3: 函数和类型注解
fn add(a: int, b: int) -> int {
    return a + b;
}

fn multiply(x: float, y: float) -> float {
    return x * y;
}

fn greet(name: string) -> string {
    return "Hello, " + name + "!";
}

// 测试4: 复合赋值运算符
fn test_compound_assignment() {
    var total: int = 0;
    total += 10;
    total += 20;
    total -= 5;
    total *= 2;
    total /= 4;

    var ratio: float = 1.0;
    ratio *= 0.5;
    ratio += 0.25;

    println(total);
    println(ratio);
}

// 测试5: 范围表达式
fn test_range_expressions() {
    // 整数范围
    let nums: List[int] = [1..10];
    let nums_inclusive: List[int] = [1..=5];

    // 浮点数范围
    let floats: List[float] = [0.0..1.0];

    // 范围用于循环
    var sum: int = 0;
    for i in 1..=100 {
        sum += i;
    }

    println(nums);
    println(nums_inclusive);
    println(sum);
}

// 测试6: Lambda表达式
fn test_lambda_expressions() {
    let double = (x: int) -> int {
        return x * 2;
    };

    let add_numbers = (a: int, b: int) -> int {
        return a + b;
    };

    let result = double(5);
    let sum = add_numbers(10, 20);

    println(result);
    println(sum);
}

// 测试7: 结构体和枚举
struct Person {
    name: string,
    age: int,
}

enum Status {
    Active,
    Inactive,
    Pending(string),
}

fn test_struct_enum() {
    let alice: Person = Person { name: "Alice", age: 30 };
    let bob: Person = Person { name: "Bob", age: 25 };

    println(alice);
    println(bob);

    let active: Status = Status::Active;
    let pending: Status = Status::Pending("Waiting for approval");

    match active {
        Status::Active => println("User is active"),
        Status::Inactive => println("User is inactive"),
        Status::Pending(msg) => println("Pending: " + msg),
    }
}

// 测试8: 引用类型和生命周期（未来扩展）
fn test_reference_types() {
    // 未来版本特性：引用类型
    // let value: ref int = 42;
    // let reference: &int = &value;
    // let mutable_ref: &mut int = &mut value;

    // println(value);
    // println(reference);

    println("Reference types ready for future implementation");
}

// 测试9: 逃逸分析场景
fn test_escape_analysis() {
    // 局部变量 - 栈分配
    let local_var: int = 100;

    // 返回值的变量 - 可能逃逸到堆
    let escaped_var: int = local_var * 2;

    // 闭包捕获的变量 - 逃逸
    // let closure = || {
    //     return local_var + 1;
    // };

    println(local_var);
    println(escaped_var);
}

// 测试10: 循环优化测试
fn test_loop_optimization() {
    // 简单循环 - 可以展开优化
    var sum1: int = 0;
    for i in 0..=99 {
        sum1 += i;
    }

    // 嵌套循环
    var sum2: int = 0;
    for i in 0..=9 {
        for j in 0..=9 {
            sum2 += i * j;
        }
    }

    // 循环不变式外提测试
    var invariant_sum: int = 0;
    let constant: int = 100;
    for k in 0..=99 {
        invariant_sum += constant;
    }

    println(sum1);
    println(sum2);
    println(invariant_sum);
}

// 测试11: 条件表达式和模式匹配
fn test_conditional_match() {
    let value: int = 42;

    // If表达式
    let message = if value > 40 {
        "Value is greater than 40"
    } else {
        "Value is 40 or less"
    };
    println(message);

    // Match表达式
    let status_code: int = 200;
    let status_message = match status_code {
        200 => "OK",
        404 => "Not Found",
        500 => "Internal Server Error",
        _ => "Unknown Status",
    };
    println(status_message);
}

// 测试12: 物理单位字面量（未来扩展）
fn test_physical_units() {
    // 未来版本特性
    // let distance: float = 100m;
    // let time: float = 5s;
    // let speed: float = distance / time; // 20 m/s

    println("Physical units ready for future implementation");
}

// 主测试函数
fn main() {
    println("=== Chim编译器功能测试 ===");

    println("\n--- 测试1: 基本类型 ---");
    test_basic_types();

    println("\n--- 测试2: 泛型类型 ---");
    test_generic_types();

    println("\n--- 测试3: 函数和类型注解 ---");
    let a = add(10, 20);
    let b = multiply(3.0, 4.0);
    let c = greet("Chim");
    println(a);
    println(b);
    println(c);

    println("\n--- 测试4: 复合赋值 ---");
    test_compound_assignment();

    println("\n--- 测试5: 范围表达式 ---");
    test_range_expressions();

    println("\n--- 测试6: Lambda表达式 ---");
    test_lambda_expressions();

    println("\n--- 测试7: 结构体和枚举 ---");
    test_struct_enum();

    println("\n--- 测试8: 引用类型 ---");
    test_reference_types();

    println("\n--- 测试9: 逃逸分析 ---");
    test_escape_analysis();

    println("\n--- 测试10: 循环优化 ---");
    test_loop_optimization();

    println("\n--- 测试11: 条件匹配 ---");
    test_conditional_match();

    println("\n--- 测试12: 物理单位 ---");
    test_physical_units();

    println("\n=== 所有测试完成 ===");
}
