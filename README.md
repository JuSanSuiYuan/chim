# Chim 编程语言编译器

Chim 是一个现代编程语言及其编译器实现，采用木兰2.0开源许可证发布。本项目旨在提供一个完整的编译器教学示例，同时也是一个功能完备的编程语言实现。

## 项目特点

### 完整的编译器架构

Chim编译器采用了经典的编译器设计模式，包含完整的词法分析、语法分析、语义分析、中间代码生成和目标代码生成等阶段。每个阶段都经过精心设计，既展示了编译器工作的基本原理，又具备实际应用价值。词法分析器使用 `logos` 库进行高效的token生成，支持整数、浮点数、字符串、布尔值等多种字面量的识别。语法分析器采用递归下降解析方式，能够正确处理表达式、函数定义、控制流语句等复杂的语法结构。语义分析器负责类型检查、作用域管理、引用有效性验证等关键任务，确保程序在运行时的正确性。

### 多目标代码生成

编译器支持多种目标平台的代码生成，满足不同场景下的使用需求。WebAssembly目标输出标准的 `.wat` 格式文件，可以直接在任何支持WebAssembly的浏览器或运行时环境中执行。Native目标生成C语言代码，便于在各种操作系统和硬件平台上进行编译和运行。IR目标输出中间表示形式，便于调试和进一步优化。这种多目标设计不仅展示了代码生成的基本原理，也为后续扩展GPU代码生成等新目标提供了良好的架构基础。

### 高级语言特性支持

Chim语言支持现代编程语言的诸多高级特性，包括函数式编程风格的lambda表达式和模式匹配，面向过程编程的函数定义和变量绑定，以及灵活的类型系统和引用语义。语言设计遵循简洁易学的原则，语法风格类似Python和Rust的混合体，既保持了表达力，又降低了学习门槛。特别值得一提的是，Chim实现了完整的所有权系统和生命周期检查，这是现代内存安全语言的核心特性，通过编译时检查消除了空指针引用、内存泄漏等常见问题。

## 快速开始

### 环境要求

构建Chim编译器需要以下软件环境。Rust工具链是必需的开发依赖，建议使用rustup进行安装和管理，确保Rust版本不低于1.70.0。操作系统方面，项目已在Windows、macOS和Linux等主流平台上完成测试，各平台的构建流程完全一致。对于代码编辑，任何支持Rust语法高亮的编辑器均可使用，Visual Studio Code配合rust-analyzer扩展是推荐的开发环境选择。

### 编译项目

使用Cargo工具链可以方便地完成项目的构建和测试。执行 `cargo build` 命令将在 `target/debug` 目录下生成可执行文件，这是开发调试阶段的常用构建方式。发布构建使用 `cargo build --release` 命令，优化后的二进制文件将位于 `target/release` 目录，性能更优但编译时间更长。运行测试套件可以使用 `cargo test` 命令，项目包含针对各模块的单元测试和集成测试，确保代码质量和功能正确性。

### 使用编译器

编译Chim源文件的基本命令格式为 `cargo run -- <source.chim> [target] [--opt <level>]`. 如果不指定目标平台，默认生成WebAssembly代码。优化级别可以通过 `--opt` 参数或短格式 `-O0`、`-O1`、`-O2` 进行设置，分别对应无优化、基本优化和激进优化三个等级。以下是一些具体的使用示例，展示了不同场景下的编译器调用方式。

```bash
# 编译为WebAssembly（默认）
cargo run -- program.chim wasm

# 编译为C语言代码
cargo run -- program.chim native

# 输出中间表示
cargo run -- program.chim ir

# 使用优化编译
cargo run -- program.chim wasm --opt=2
cargo run -- program.chim native -O1
```

### 示例程序

以下是一个简单的Chim程序示例，展示了语言的基本语法特性。函数定义使用 `fn` 关键字，参数列表和返回值类型位于参数括号之后，函数体可以是单个表达式或包含多条语句的代码块。变量绑定使用 `let` 关键字，支持显式类型声明和类型推断两种方式。

```chim
fn add(a: int, b: int) -> int = a + b;

fn multiply(x: int, y: int) -> int = x * y;

fn main() {
    let result: int = add(10, 20);
    let product: int = multiply(5, 6);
}
```

## 项目结构

```
chim_compiler/
├── Cargo.toml           # 项目配置文件
├── src/
│   ├── main.rs          # 程序入口和命令行处理
│   ├── ast.rs           # 抽象语法树定义
│   ├── lexer.rs         # 词法分析器
│   ├── parser.rs        # 语法分析器
│   ├── semantic.rs      # 语义分析器
│   ├── ir.rs            # 中间表示定义
│   ├── codegen.rs       # IR生成器
│   ├── wasm_codegen.rs  # 目标代码生成器
│   └── optimizer.rs     # 代码优化器
├── test_basic.chim      # 基础测试文件
└── test_comprehensive.chim  # 综合测试文件
```

## 语言规范

Chim语言的语法规范定义在 `chim语法规范.md` 文档中，设计理念阐述在 `chim设计理念.md` 文档中。这两份文档详细描述了语言的类型系统、表达式语法、语句结构以及标准库等内容，是理解语言设计和实现的重要参考资料。语言设计遵循渐进式复杂性原则，从简单的函数式表达式开始，逐步引入更复杂的控制流和类型特性，使学习过程平滑自然。

## 技术架构

编译器采用模块化设计，各阶段职责清晰划分。词法分析阶段负责将源代码转换为token序列，为语法分析提供基础。语法分析阶段根据文法规则验证token序列的结构正确性，并构建抽象语法树。语义分析阶段在语法树基础上进行类型推断、作用域解析和生命周期检查。中间代码生成阶段将抽象语法树转换为平台无关的中间表示，便于后续优化和多目标代码生成。目标代码生成阶段将中间表示转换为特定平台的机器码或可执行格式。

中间表示层是连接前端分析和后端生成的关键桥梁。IR模块定义了类型系统，包括基本类型、引用类型、数组类型和结构体类型。指令集涵盖内存操作、算术运算、比较运算、逻辑运算、控制流和函数调用等完整的操作语义。模块结构支持函数、全局变量和结构体的组织，便于复杂程序的表示和生成。

代码生成层实现了针对不同目标的专门生成器。WASMGenerator生成符合WebAssembly规范的文本格式代码，支持浏览器和Node.js环境运行。NativeGenerator生成可移植的C语言代码，便于在任何支持C编译器的平台上使用。生成器采用模板化的设计模式，通过统一的目标代码生成接口支持灵活的目标扩展。

优化器实现了多种代码优化技术。常数传播分析识别程序中的常量表达式，在编译时直接计算结果，消除不必要的运行时计算。函数内联将小函数体展开到调用点，消除函数调用开销，提高代码局部性。优化过程分为多个级别，用户可以根据性能和编译时间的权衡选择合适的优化等级。

## 扩展与贡献

项目采用木兰2.0开源许可证，允许自由使用、修改和分发。鼓励开发者通过以下方式参与项目贡献：报告发现的问题和漏洞，提出功能改进建议，提交代码补丁和优化实现，完善文档和测试用例。项目的扩展方向包括：添加GPU代码生成支持（CUDA或OpenCL），实现更多的代码优化Pass，完善标准库和运行时支持，以及增加对更多目标平台的支持。

## 许可证

本项目采用木兰公共许可证第二版（Mulan PSL v2）开源许可。关于许可证的详细信息，请参阅 LICENSE 文件或访问木兰开源社区获取官方说明。

## 致谢

感谢所有为项目做出贡献的开发者，以及开源社区提供的优秀工具和库。项目的成功离不开社区的支持和反馈，欢迎更多开发者加入我们，共同推动Chim语言和编译器技术的发展。
